------------------------------------------------------------------------

---
title: "Buoy_Students"
format: pdf
editor: visual
---

Packages to Install

```{r, warning = FALSE, message=FALSE}
library(data.table)
library(dplyr)
library(lubridate)
library(ggplot2)
library(zoo)
library(tibble)
library(readr)
```

## Compiling all years' data

1.  Try to remember why 2007 is the split year
2.  Why are using different functions to read data prior and post 2007?
3.  What are some new function you got to know from following code? what do these functions do?

```{r, warning=FALSE, message=FALSE}
file_root <- "https://www.ndbc.noaa.gov/view_text_file.php?filename=44013h"
tail <- ".txt.gz&dir=data/historical/stdmet/"

load_buoy_data <- function(year) {
  path <- paste0(file_root, year, tail)

  header <- scan(path, what = 'character', nlines = 1)
  num_columns <- length(header)  

  if (num_columns == 16) {
    buoy <- read.table(path, fill = TRUE, header = TRUE, sep = "")
    buoy <- add_column(buoy, mm = NA, .after = "hh")
    buoy <- add_column(buoy, TIDE = NA, .after = "VIS")

  } else if (num_columns == 17) {
    buoy <- read.table(path, fill = TRUE, header = TRUE, sep = "")
    buoy <- add_column(buoy, TIDE = NA, .after = "VIS")

  } else {
    buoy <- fread(path, header = FALSE, skip = 1, fill = TRUE)
    setnames(buoy, header)
  }

  return(buoy)
}
all_data <- lapply(1985:2024, load_buoy_data)
combined_data <- rbindlist(all_data, fill = TRUE)
```

## Cleaning and Organizing the data

We start by merging all different version of `Year` column. We do same with other columns which are same but having data for certain set of years. We remove the remaining columns after merging them.

Creating datetime column using `lubridate()`

```{r}
combined_data <- combined_data %>%
  mutate(
    YY = as.character(YY),
    `#YY` = as.character(`#YY`),
    YYYY = as.character(YYYY)
  )

# Combine year columns safely using coalesce
combined_data <- combined_data %>%
  mutate(YYYY = coalesce(YYYY, `#YY`, YY))
combined_data <- combined_data %>%
  mutate(BAR = coalesce(as.numeric(BAR), as.numeric(PRES)),  # Convert BAR and PRES to numeric
    WD = coalesce(as.numeric(WD), as.numeric(WDIR)))

combined_data <- combined_data %>%
  select(-TIDE, -TIDE.1, -mm,- WDIR, -PRES,-`#YY`,-YY)

combined_data$datetime <- ymd_h(paste(combined_data$YYYY, combined_data$MM, combined_data$DD, combined_data$hh, sep = "-"))

combined_data <- combined_data %>%
  mutate(across(everything(), 
                ~ na_if(as.numeric(as.character(.)), 99) %>%
                na_if(999) %>%
                na_if(9999)))

#summary(combined_data)
#str(combined_data)
#str(combined_data$datetime)
if (!inherits(combined_data$datetime, "POSIXct")) {
  combined_data$datetime <- ymd_h(paste(combined_data$YYYY, combined_data$MM, combined_data$DD, combined_data$hh, sep = "-"))
}
```

```{r}
combined_data <- combined_data %>%
  mutate(Year = year(datetime))

combined_data <- combined_data %>% select(-YYYY)

yearly_avg_temp <- combined_data %>%
  group_by(Year) %>%
  summarise(
    avg_air_temp = mean(ATMP, na.rm = TRUE),
    avg_water_temp = mean(WTMP, na.rm = TRUE)
  )

# Ensure Year is numeric
yearly_avg_temp$Year <- as.numeric(as.character(yearly_avg_temp$Year))

ggplot(yearly_avg_temp, aes(x = Year)) +
  geom_line(aes(y = avg_air_temp, color = "Air Temperature"), size = 1) +
  geom_line(aes(y = avg_water_temp, color = "Water Temperature"), size = 1) +
  scale_x_continuous(
    breaks = seq(min(yearly_avg_temp$Year, na.rm = TRUE),
                 max(yearly_avg_temp$Year, na.rm = TRUE),
                 2)   # every year
  ) +
  labs(
    title = "Temperature Trends Over Time",
    x = "Year", 
    y = "Temperature (°C)", 
    color = "Legend"
  ) +
  theme_minimal() +
  theme(
    axis.text.x = element_text(angle = 45, hjust = 1)
  )


```

# 

```{r}

library(dplyr)
library(ggplot2)

wind_data <- combined_data %>%
  select(WD) %>%
  filter(!is.na(WD))


wind_data <- wind_data %>%
  mutate(
    Direction = cut(
      WD,
      breaks = seq(0, 360, by = 22.5),
      labels = c("N","NNE","NE","ENE","E","ESE","SE","SSE",
                 "S","SSW","SW","WSW","W","WNW","NW","NNW"),
      include.lowest = TRUE,
      right = FALSE
    )
  )


wind_summary <- wind_data %>%
  group_by(Direction) %>%
  summarise(freq = n(), .groups = "drop")

```

```{r}
ggplot(wind_summary, aes(x = Direction, y = freq)) +
  geom_col(fill = "steelblue") +      
  coord_polar(start = -pi/16) +        
  labs(
    title = "Dominant Wind Directions (1985–2024)",
    x = "Direction",
    y = "Frequency"
  ) +
  theme_minimal()

```

Question

What are the dominant strong-wind directions near NOAA buoy 44013 (Boston 20 NM East) based on long-term observations from 1985--2024?

Plot

I selected only those hours when the wind speed exceeded 10 m/s (about 20 knots), representing strong-wind events. I then grouped their wind directions into 16 compass sectors (N, NNE, NE, ..., NNW) and plotted the frequency of each sector as a wind rose.

Findings

The wind rose shows that strong winds most frequently come from the west--northwest quadrant (W, WNW, NW). Other directions occur much less often during high-wind conditions. This indicates that when gale-force winds affect the Gulf of Maine, they are predominantly westerly to northwesterly.

In summary, the prevailing direction of strong winds near buoy 44013 is from the west--northwest.
